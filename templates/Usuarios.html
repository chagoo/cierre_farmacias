<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Usuarios</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
	<style>
		body { padding: 20px; }
		table input.form-control { height: 32px; padding: 2px 8px; }
		.actions { white-space: nowrap; }
	</style>
	<link rel="icon" href="{{ url_for('static', filename='Imagenes/LogoBenavides.jpg') }}">
	<script>
		// Small helper for POSTing form-encoded data
		async function postForm(url, data) {
			const form = new URLSearchParams();
			for (const [k, v] of Object.entries(data)) form.append(k, v ?? '');
			const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body: form });
			if (!res.ok) throw new Error((await res.text()) || res.statusText);
			return res.json().catch(() => ({}));
		}
	</script>
</head>
<body>
	<div class="container-fluid">
		<div class="d-flex align-items-center justify-content-between mb-3">
			<h3 class="m-0">Usuarios</h3>
			<div class="d-flex gap-2">
				<a class="btn btn-outline-secondary" href="{{ url_for('dashboard.dashboard_home') }}">Dashboard</a>
				<a class="btn btn-primary" href="{{ url_for('admin.accesos') }}">Nuevo usuario</a>
			</div>
		</div>

		{% if usuarios and usuarios|length > 0 %}
		<div class="table-responsive">
			<table class="table table-striped table-bordered align-middle" id="tabla-usuarios">
				<thead class="table-light">
					<tr>
						<th>ID</th>
						<th>Nombre</th>
						<th>Apellido Paterno</th>
						<th>Apellido Materno</th>
						<th>Usuario</th>
						<th>Correo</th>
						<th>Departamento</th>
						<th>Nivel Acceso</th>
						<th class="actions">Acciones</th>
					</tr>
				</thead>
				<tbody>
					{% for u in usuarios %}
					<tr data-id="{{ u.id }}">
						<td class="text-muted">{{ u.id }}</td>
						<td><input class="form-control" name="nombre" value="{{ u.Nombre }}" /></td>
						<td><input class="form-control" name="apellido_paterno" value="{{ u.Apellido_Paterno }}" /></td>
						<td><input class="form-control" name="apellido_materno" value="{{ u.Apellido_Materno }}" /></td>
						<td class="text-muted">{{ u.Usuario }}</td>
						<td class="text-muted">{{ u.Correo }}</td>
						<td><input class="form-control" name="departamento" value="{{ u.Departamento }}" /></td>
						<td><input class="form-control" name="nivel_acceso" value="{{ u.Nivel_Acceso }}" /></td>
						<td class="actions">
							<div class="btn-group btn-group-sm" role="group">
								<button class="btn btn-success" onclick="guardar(this)">Guardar</button>
								<button class="btn btn-danger" onclick="eliminar(this)">Eliminar</button>
							</div>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
			<div class="alert alert-info">No hay usuarios para mostrar en este entorno.</div>
		{% endif %}
	</div>

	<script>
		function rowToData(tr) {
			const id = tr.dataset.id;
			const get = (name) => tr.querySelector(`[name="${name}"]`)?.value || '';
			return {
				id,
				nombre: get('nombre'),
				apellido_paterno: get('apellido_paterno'),
				apellido_materno: get('apellido_materno'),
				password: '', // vacío si no se cambia
				departamento: get('departamento'),
				nivel_acceso: get('nivel_acceso')
			};
		}

		async function guardar(btn) {
			const tr = btn.closest('tr');
			btn.disabled = true;
			try {
				const data = rowToData(tr);
				const r = await postForm("{{ url_for('admin.actualizar_usuario') }}", data);
				alert('Guardado');
			} catch (e) {
				alert('Error al guardar: ' + e.message);
			} finally {
				btn.disabled = false;
			}
		}

		async function eliminar(btn) {
			const tr = btn.closest('tr');
			if (!confirm('¿Eliminar este usuario?')) return;
			btn.disabled = true;
			try {
				const r = await postForm("{{ url_for('admin.eliminar_usuario') }}", { id: tr.dataset.id });
				tr.remove();
			} catch (e) {
				alert('Error al eliminar: ' + e.message);
			} finally {
				btn.disabled = false;
			}
		}
	</script>
</body>
</html>
